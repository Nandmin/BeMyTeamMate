<div class="layout-content-container flex flex-col w-full max-w-7xl flex-1 mx-auto px-4 sm:px-6 lg:px-8 py-5">
    <!-- Title Section -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 pb-6 pt-2">
        <div>
            <h1 class="text-white tracking-tight text-[32px] md:text-[40px] font-extrabold leading-tight">Tagságaim
            </h1>
            <p class="text-gray-400 mt-2 text-sm md:text-base">Kezeld a csoportjaidat, vagy csatlakozz újakhoz.</p>
        </div>
    </div>
    <!-- Action Panel -->
    <div class="mb-6">
        <div
            class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 rounded-2xl border border-border-green bg-surface-card p-6 shadow-lg shadow-green-900/5 transition-all hover:border-primary/30">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">group_add</span>
                    <p class="text-white text-lg font-bold leading-tight">Új kalandot keresel?</p>
                </div>
                <p class="text-[#92c9a9] text-sm md:text-base font-normal leading-normal max-w">
                    Hozz létre egy új baráti kört a sportoláshoz, vagy csatlakozz egy meglévőhöz.
                </p>
            </div>
            <div class="flex flex-wrap gap-3 w-full md:w-auto">
                <button (click)="toggleCreateModal()" [disabled]="!authService.currentUser()"
                    [title]="!authService.currentUser() ? 'Jelentkezz be a csoport létrehozásához!' : ''"
                    class="flex-1 md:flex-none flex min-w-[140px] cursor-pointer items-center justify-center rounded-xl h-10 px-5 bg-primary hover:bg-[#1fd46c] text-white text-sm font-bold leading-normal transition-transform active:scale-95 shadow-[0_0_15px_rgba(43,238,124,0.3)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="mr-2 material-symbols-outlined text-[20px]">add</span>
                    Új csoport
                </button>
                <button (click)="toggleJoinModal()" [disabled]="!authService.currentUser()"
                    [title]="!authService.currentUser() ? 'Jelentkezz be a csatlakozáshoz!' : ''"
                    class="flex-1 md:flex-none flex min-w-[140px] cursor-pointer items-center justify-center rounded-xl h-10 px-5 bg-transparent border border-border-green hover:border-white text-white text-sm font-bold leading-normal transition-colors active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="mr-2 material-symbols-outlined text-[20px]">key</span>
                    Csatlakozás
                </button>
            </div>
        </div>
    </div>

    <!-- Filter & Search Toolbar -->
    <!-- <div
        class="py-4 sticky top-[72px] z-30 bg-background-dark/95 backdrop-blur-md mb-4 -mx-4 md:mx-0 md:static md:bg-transparent">
        <div class="flex flex-col md:flex-row gap-4 justify-between items-center"> -->
            <!-- Search -->
            <!-- <div class="relative w-full md:max-w-[950px]">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                    <span class="material-symbols-outlined">search</span>
                </div>
                <input
                    class="block w-full p-2.5 pl-10 text-sm text-white bg-surface-card border border-border-green rounded-xl focus:ring-primary focus:border-primary placeholder-gray-500"
                    placeholder="Keresés név alapján..." type="text" />
            </div> -->
            <!-- View Toggles -->
            <!-- View Toggles (Removed for Carousel Layout) -->
            <!-- <div class="flex items-center gap-2 self-end md:self-auto">...</div> -->
        <!-- </div>
    </div> -->

    <!-- Carousel Content -->
    <div class="relative group/carousel mt-8">
        <!-- Left Navigation Button -->
        <button (click)="scrollCarousel('left')"
            class="absolute left-0 top-1/2 -translate-y-1/2 -ml-4 z-20 p-3 rounded-full bg-surface-card border border-border-green shadow-xl text-white hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover/carousel:opacity-100 hidden md:flex items-center justify-center scale-90 hover:scale-100 active:scale-90 ring-1 ring-white/10">
            <span class="material-symbols-outlined">chevron_left</span>
        </button>

        <!-- Right Navigation Button -->
        <button (click)="scrollCarousel('right')"
            class="absolute right-0 top-1/2 -translate-y-1/2 -mr-4 z-20 p-3 rounded-full bg-surface-card border border-border-green shadow-xl text-white hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover/carousel:opacity-100 hidden md:flex items-center justify-center scale-90 hover:scale-100 active:scale-90 ring-1 ring-white/10">
            <span class="material-symbols-outlined">chevron_right</span>
        </button>

        @if (groups() !== undefined) {
        <div #carouselContainer
            class="carousel-container flex overflow-x-auto gap-4 pb-8 snap-x snap-mandatory [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none] -mx-4 px-4 sm:mx-0 sm:px-0 scroll-smooth">
            @for (group of groups(); track group.id) {
            <div (click)="navigateToGroup(group.id!)"
                class="min-w-[260px] w-[260px] snap-center group relative flex flex-col overflow-hidden rounded-2xl bg-surface-card border border-border-green hover:border-primary/50 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-primary/10 cursor-pointer">
                <!-- Cover Image -->
                <div class="h-32 w-full overflow-hidden relative">
                    <img [src]="resolveCoverImage(group.image)" [alt]="group.name"
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110" />
                    <div
                        class="absolute top-2 right-2 backdrop-blur-md px-2 py-0.5 rounded-lg flex items-center gap-1">
                        <span class="material-symbols-outlined text-primary text-[14px]">verified_user</span>
                        <!-- <span class="text-[9px] font-bold text-white uppercase tracking-wider">Létrehozó</span> -->
                    </div>
                </div>
                <!-- Content -->
                <div class="flex flex-1 flex-col p-4">
                    <div class="flex justify-between items-start mb-1">
                        <h3
                            class="text-lg font-bold text-white group-hover:text-primary transition-colors line-clamp-1">
                            {{
                            group.name }}
                        </h3>
                        <!-- <button class="text-gray-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[20px]">more_vert</span>
                        </button> -->
                    </div>
                    <p class="text-xs text-gray-400 mb-3 line-clamp-2">{{ group.description || 'Nincs leírás megadva.'
                        }}
                    </p>
                    <div class="mt-auto flex items-center justify-between pt-3 border-t border-white/10">
                        <div class="flex -space-x-2 overflow-hidden">
                            <a [routerLink]="['/profile', group.ownerId]" (click)="$event.stopPropagation()"
                                class="contents">
                                <img [src]="group.ownerPhoto || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + group.ownerId"
                                    [alt]="group.ownerName"
                                    class="inline-block h-6 w-6 rounded-full ring-2 ring-surface-card object-cover cursor-pointer hover:ring-primary transition-all" />
                            </a>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-1.5 py-0.5 rounded text-[9px] uppercase font-bold"
                                [ngClass]="group.type === 'open' ? 'bg-primary/20 text-primary' : 'bg-gray-500/20 text-gray-400'">
                                {{ group.type === 'open' ? 'Nyílt' : 'Zárt' }}
                            </span>
                            <div class="flex items-center gap-1 text-[10px] text-gray-400">
                                <span class="material-symbols-outlined text-[14px]">group</span>
                                <span>{{ group.memberCount }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Card 4 (Join New Suggestion) -->
            <!-- <div (click)="authService.currentUser() ? toggleCreateModal() : null"
                [class.opacity-50]="!authService.currentUser()" [class.cursor-not-allowed]="!authService.currentUser()"
                class="min-w-[260px] w-[260px] snap-center group relative flex flex-col items-center justify-center overflow-hidden rounded-2xl border-2 border-dashed border-border-green bg-transparent p-4 hover:border-primary/50 hover:bg-surface-card/50 transition-all duration-300 cursor-pointer">
                <div
                    class="size-12 rounded-full bg-surface-card group-hover:bg-primary/20 flex items-center justify-center mb-3 transition-colors">
                    <span
                        class="material-symbols-outlined text-3xl text-gray-400 group-hover:text-primary transition-colors">add</span>
                </div>
                <h3 class="text-base font-bold text-gray-300 group-hover:text-white mb-1">Új csoport</h3>
                <p class="text-xs text-center text-gray-500 max-w-[150px]">
                    {{ authService.currentUser() ? 'Hozz létre egy új csoportot!' : 'Jelentkezz be!' }}
                </p>
            </div> -->
        </div>
        } @else {
        <div class="-mx-4 px-4 sm:mx-0 sm:px-0">
            <div
                class="h-[220px] rounded-2xl bg-surface-card/60 border border-border-green animate-pulse flex items-center justify-center text-xs text-gray-500">
                Betoltes...
            </div>
        </div>
        }
    </div>
</div>



<!-- Create Group Modal -->
@if (showCreateModal) {
<div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-background-dark/80 backdrop-blur-sm" (click)="toggleCreateModal()"></div>

    <!-- Modal Content -->
    <div
        class="relative w-full max-w-lg bg-surface-card border border-border-green rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
        <div class="p-6 border-b border-border-green">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-white">Új csoport létrehozása</h2>
                <button (click)="toggleCreateModal()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <form [formGroup]="groupForm" (ngSubmit)="onCreateGroup()" class="p-6 space-y-6">
            <!-- Group Name -->
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-400">Csoport neve</label>
                <input type="text" formControlName="name" placeholder="Pl. Szerdai Foci"
                    class="group-creation-input w-full bg-background-dark border border-border-green rounded-xl p-3 text-white placeholder-gray-600 focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
                @if (groupForm.get('name')?.touched && groupForm.get('name')?.errors?.['required']) {
                <p class="text-xs text-red-500 mt-1">A csoport név megadása kötelező.</p>
                }
            </div>

            <!-- Group Type -->
            <div class="space-y-4">
                <label class="text-sm font-medium text-gray-400">Csoport típusa</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="relative cursor-pointer group">
                        <input type="radio" formControlName="type" value="closed" class="peer sr-only" />
                        <div
                            class="p-4 rounded-xl border border-border-green bg-background-dark/50 peer-checked:border-primary transition-all flex flex-col items-center gap-2">
                            <span
                                class="material-symbols-outlined text-gray-400 group-hover:text-white peer-checked:text-primary">lock</span>
                            <span class="text-sm font-bold text-gray-400 peer-checked:text-white">Zárt</span>
                        </div>
                    </label>
                    <label class="relative cursor-pointer group">
                        <input type="radio" formControlName="type" value="open" class="peer sr-only" />
                        <div
                            class="p-4 rounded-xl border border-border-green bg-background-dark/50 peer-checked:border-primary transition-all flex flex-col items-center gap-2">
                            <span
                                class="material-symbols-outlined text-gray-400 group-hover:text-white peer-checked:text-primary">public</span>
                            <span class="text-sm font-bold text-gray-400 peer-checked:text-white">Nyílt</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Description (Optional) -->
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-400">Leírás (opcionális)</label>
                <textarea formControlName="description" rows="3" placeholder="Miről szól ez a csoport?"
                    class="group-creation-input w-full bg-background-dark border border-border-green rounded-xl p-3 text-white placeholder-gray-600 focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" [disabled]="groupForm.invalid || isSubmitting"
                class="w-full py-4 bg-primary hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed text-white font-extrabold rounded-xl shadow-lg shadow-primary/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                @if (isSubmitting) {
                <span class="animate-spin material-symbols-outlined">sync</span>
                Létrehozás...
                } @else {
                <span class="material-symbols-outlined">add_circle</span>
                Csoport létrehozása
                }
            </button>
        </form>
    </div>
</div>
}

<!-- Join Group Modal -->
@if (showJoinModal) {
<div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-background-dark/80 backdrop-blur-sm" (click)="toggleJoinModal()"></div>

    <!-- Modal Content -->
    <div
        class="relative w-full max-w-lg bg-surface-card border border-border-green rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
        <div class="p-6 border-b border-border-green">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-white">Csatlakozás csoporthoz</h2>
                <button (click)="toggleJoinModal()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <form [formGroup]="joinForm" (ngSubmit)="onJoinGroup()" class="p-6 space-y-6">
            <!-- Group Name -->
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-400">Csoport neve</label>
                <input type="text" formControlName="groupName" placeholder="Írd be a keresett csoport nevét"
                    class="group-creation-input w-full bg-background-dark border border-border-green rounded-xl p-3 text-white placeholder-gray-600 focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
                @if (joinForm.get('groupName')?.touched && joinForm.get('groupName')?.errors?.['required']) {
                <p class="text-xs text-red-500 mt-1">A csoport név megadása kötelező.</p>
                }
            </div>
            <p class="text-sm text-gray-400">
                A csatlakozáshoz a csoport adminisztrátorának jóváhagyása szükséges.
            </p>
            <label
                class="flex items-start gap-3 rounded-xl border border-border-green/50 bg-background-dark/60 p-4 text-sm text-gray-300 text-justify">
                <input type="checkbox" formControlName="joinConsent"
                    class="mt-1 h-4 w-4 accent-primary rounded border border-border-green bg-background-dark" />
                <span>
                    Tudomásul veszem, hogy csatlakozás után a csoport tagjai láthatják a megjelenített
                    nevemet/profilomat és a részvételi jelzéseimet, valamint nyilvános csoport esetén a
                    csoport alapadatai a csoporton kívül is megjelenhetnek.
                </span>
            </label>
            @if (joinForm.get('joinConsent')?.touched && joinForm.get('joinConsent')?.errors?.['required']) {
            <p class="text-md text-center text-red-500">
                A csatlakozás csak a tájékoztatás elfogadásával indítható.
            </p>
            }

            <!-- Submit Button -->
            <button type="submit" [disabled]="joinForm.invalid || isSubmitting"
                class="w-full py-4 bg-primary hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed text-white font-extrabold rounded-xl shadow-lg shadow-primary/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                @if (isSubmitting) {
                <span class="animate-spin material-symbols-outlined">sync</span>
                Keresés...
                } @else {
                <span class="material-symbols-outlined">login</span>
                Csatlakozás kérése
                }
            </button>
        </form>
    </div>
</div>
}
