rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isSiteAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() && exists(userPath) && get(userPath).data.role == 'siteadmin';
    }

    function isUserAdminOfGroup(uid, groupId) {
      let groupPath = /databases/$(database)/documents/groups/$(groupId);
      let memberPath = /databases/$(database)/documents/groups/$(groupId)/members/$(uid);
      return exists(groupPath) && (
        get(groupPath).data.ownerId == uid ||
        (exists(memberPath) && get(memberPath).data.isAdmin == true)
      );
    }

    function isGroupAdmin(groupId) {
      return isSignedIn() && (
        isSiteAdmin() ||
        isUserAdminOfGroup(request.auth.uid, groupId)
      );
    }

    // 1. User documents
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // Global siteadmin role is FORBIDDEN from client side
      allow create: if isSignedIn() && request.auth.uid == userId && 
                    !('role' in request.resource.data);
      
      allow update: if isSignedIn() && (
        // Self-update: cannot touch role
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        // Site Admin: can update anything
        isSiteAdmin() ||
        // Group Admin update: can update elo/formFactor if they prove shared membership
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['elo', 'formFactor', 'lastGroupId']) &&
          'lastGroupId' in request.resource.data &&
          isGroupAdmin(request.resource.data.lastGroupId) &&
          exists(/databases/$(database)/documents/groups/$(request.resource.data.lastGroupId)/members/$(userId))
        )
      );

      // User group summaries
      match /groups/{groupId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // User notifications
      match /notifications/{notificationId} {
        allow read, update, delete: if isSignedIn() && request.auth.uid == userId;
        
        allow create: if isSignedIn() && (
          isSiteAdmin() ||
          (
            request.resource.data.get('groupId', '') is string &&
            request.resource.data.get('type', '') is string &&
            (
              request.resource.data.get('actorId', '') is string &&
              request.resource.data.actorId == request.auth.uid
            ) &&
            (
              // Case 1: Teammates (Both must be members of the group)
              (exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(request.auth.uid)) &&
               exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(userId))) ||
              
              // Case 2: Join Request (User notifying Group Admins)
              (request.resource.data.type == 'group_join' && 
               isUserAdminOfGroup(userId, request.resource.data.groupId) &&
               exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/joinRequests/$(request.auth.uid))) ||
              
              // Case 3: Joined/Rejected Decision or Admin Action
              (isGroupAdmin(request.resource.data.groupId) && 
               (exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(userId)) ||
                exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/joinRequests/$(userId))))
            )
          )
        );
      }
    }

    // 2. Collection group match for members (for queries)
    match /{path=**}/members/{memberId} {
      allow read: if isSignedIn();
    }

    // 3. Groups
    match /groups/{groupId} {
      allow read, create: if isSignedIn();

      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        isSiteAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount'])
      );

      allow delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isSiteAdmin());

      match /events/{eventId} {
        allow read: if isSignedIn() && (
          isGroupAdmin(groupId) || 
          exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid)) ||
          exists(/databases/$(database)/documents/groups/$(groupId)/joinRequests/$(request.auth.uid))
        );
        
        // Only Group Admins can create or delete events
        allow create, delete: if isGroupAdmin(groupId);
        
        // Update: Admins can update anything. Members can ONLY update RSVP fields with validation.
        allow update: if isSignedIn() && (
          isGroupAdmin(groupId) || (
            exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid)) &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees', 'currentAttendees']) &&
            request.resource.data.attendees is list &&
            request.resource.data.currentAttendees is int &&
            request.resource.data.currentAttendees >= 0 &&
            (!('maxAttendees' in resource.data) || request.resource.data.currentAttendees <= resource.data.maxAttendees) &&
            (!('groupId' in request.resource.data) || request.resource.data.groupId == groupId)
          )
        );
      }

      match /members/{memberId} {
        allow read: if isSignedIn();
        
        // Joining or Owner Setup:
        allow create: if isSignedIn() && (
          // Case 1: Self-setup or Self-join
          (
            request.auth.uid == memberId && 
            request.resource.data.userId == request.auth.uid &&
            (
              // 1a: The Group Owner can set themselves as Admin (e.g. initial setup batch)
              // Note: Using existsAfter/getAfter here to support the creation batch.
              (existsAfter(/databases/$(database)/documents/groups/$(groupId)) && 
               getAfter(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid) ||
              // 1b: Regular user joining must be restricted (Only for Open groups)
              (
                request.resource.data.get('isAdmin', false) == false &&
                request.resource.data.get('role', 'user') == 'user' &&
                exists(/databases/$(database)/documents/groups/$(groupId)) &&
                get(/databases/$(database)/documents/groups/$(groupId)).data.type == 'open'
              )
            )
          ) ||
          // Case 2: Group Admin adding someone or approving a request
          (
            isGroupAdmin(groupId) &&
            request.resource.data.userId == memberId &&
            request.resource.data.get('role', 'user') in ['user', 'admin', 'CsapatkapitÃ¡ny']
          )
        );
        
        // Updating: Group Admin can change anything (role, isAdmin). 
        // User can change their own data but NOT their role/isAdmin.
        allow update: if isSignedIn() && (
          isGroupAdmin(groupId) ||
          (request.auth.uid == memberId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isAdmin']))
        );
        
        // Leaving or Removing: User can delete own doc, Admin can delete any
        allow delete: if isSignedIn() && (request.auth.uid == memberId || isGroupAdmin(groupId));
      }

      match /joinRequests/{requestId} {
        // Read: Only the requester or group admins can see the request
        allow read: if isSignedIn() && (request.auth.uid == requestId || isGroupAdmin(groupId));
        
        // Create: Only the user can create their own join request, ensuring identity
        allow create: if isSignedIn() && request.auth.uid == requestId && 
                      request.resource.data.userId == request.auth.uid;
        
        // Update: Only group admins can update the request (e.g., status change)
        allow update: if isGroupAdmin(groupId);
        
        // Delete: Requester can cancel their own, or group admin can reject/remove it
        allow delete: if isSignedIn() && (request.auth.uid == requestId || isGroupAdmin(groupId));
      }
    }
  }
}
