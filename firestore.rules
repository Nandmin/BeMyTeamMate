rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isSiteAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'siteadmin';
    }

    function isUserAdminOfGroup(uid, groupId) {
      return exists(/databases/$(database)/documents/groups/$(groupId)) && (
        get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == uid ||
        (exists(/databases/$(database)/documents/groups/$(groupId)/members/$(uid)) && 
         get(/databases/$(database)/documents/groups/$(groupId)/members/$(uid)).data.isAdmin == true)
      );
    }

    function isGroupAdmin(groupId) {
      return isSignedIn() && (
        isSiteAdmin() ||
        isUserAdminOfGroup(request.auth.uid, groupId)
      );
    }

    // 1. User documents
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // Global siteadmin role is FORBIDDEN from client side
      allow create: if isSignedIn() && request.auth.uid == userId && 
                    !('role' in request.resource.data);
      
      allow update: if isSignedIn() && (
        // Self-update: cannot touch role
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        // Site Admin: can update anything
        isSiteAdmin() ||
        // Group Admin update: can update elo/formFactor if they prove shared membership
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['elo', 'formFactor', 'lastGroupId']) &&
          'lastGroupId' in request.resource.data &&
          isGroupAdmin(request.resource.data.lastGroupId) &&
          exists(/databases/$(database)/documents/groups/$(request.resource.data.lastGroupId)/members/$(userId))
        )
      );

      // User group summaries
      match /groups/{groupId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // User notifications
      match /notifications/{notificationId} {
        allow read, update, delete: if isSignedIn() && request.auth.uid == userId;
        
        allow create: if isSignedIn() && (
          isSiteAdmin() ||
          (
            'groupId' in request.resource.data && 
            (
              // Case 1: Teammates (Both must be members of the group)
              (exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(request.auth.uid)) &&
               exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(userId))) ||
              
              // Case 2: Join Request (User notifying Group Admins)
              (request.resource.data.type == 'group_join' && isUserAdminOfGroup(userId, request.resource.data.groupId)) ||
              
              // Case 3: Joined/Rejected Decision or Admin Action
              // Admin can notify user only if user is a member or has a join request
              (isGroupAdmin(request.resource.data.groupId) && 
               (exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/members/$(userId)) ||
                exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId)/joinRequests/$(userId))))
            )
          )
        );
      }
    }

    // 2. Collection group match for members (for queries)
    match /{path=**}/members/{memberId} {
      allow read: if isSignedIn();
    }

    // 3. Groups
    match /groups/{groupId} {
      allow read, create: if isSignedIn();

      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        isSiteAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount'])
      );

      allow delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isSiteAdmin());

      match /events/{eventId} {
        allow read, write: if isSignedIn();
      }

      match /members/{memberId} {
        allow read: if isSignedIn();
        
        // Joining: user can create their own member doc
        allow create: if isSignedIn() && request.auth.uid == memberId;
        
        // Updating: Group Admin can change anything (role, isAdmin). 
        // User can change their own data but NOT their role/isAdmin.
        allow update: if isSignedIn() && (
          isGroupAdmin(groupId) ||
          (request.auth.uid == memberId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isAdmin']))
        );
        
        // Leaving or Removing: User can delete own doc, Admin can delete any
        allow delete: if isSignedIn() && (request.auth.uid == memberId || isGroupAdmin(groupId));
      }

      match /joinRequests/{requestId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
  }
}
