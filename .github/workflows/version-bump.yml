name: Auto Bump Version

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump-version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Determine bump type from commit message
        id: bump
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || '' }}
        run: |
          commit_message="$COMMIT_MESSAGE"
          bump="patch"

          if [[ "$commit_message" == *"BREAKING CHANGE"* ]] || [[ "$commit_message" =~ ^(feat|fix|chore|refactor|perf|test|docs|build|ci|style)(\(.+\))?!: ]]; then
            bump="major"
          elif [[ "$commit_message" =~ ^feat(\(.+\))?: ]]; then
            bump="minor"
          fi

          echo "type=$bump" >> "$GITHUB_OUTPUT"

      - name: Bump package version
        run: npm version "${{ steps.bump.outputs.type }}" --no-git-tag-version

      - name: Sync source app version
        run: node scripts/sync-app-version.mjs

      - name: Commit version files and create tag
        run: |
          new_version="$(node -p "require('./package.json').version")"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json src/environments/app-version.ts

          if git diff --cached --quiet; then
            echo "No version changes to commit."
            exit 0
          fi

          git commit -m "chore(release): v${new_version} [skip ci]"
          git tag "v${new_version}"
          git push origin "HEAD:${{ github.ref_name }}"
          git push origin "v${new_version}"
